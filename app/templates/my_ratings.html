{% extends "base.html" %}

{% block title %}Mes notes - Moteur de Séries TV{% endblock %}

{% block content %}
<div class="fade-in">
  <div class="card">
    <div class="card-header">
      <h1 class="card-title"><i class="fas fa-bookmark"></i> Mes notes</h1>
    </div>
    <div class="ratings-controls">
      <button type="button" id="ratings-sort-toggle" class="btn btn-outline-light btn-icon" aria-label="Trier par note d&#233;croissante" title="Trier par note d&#233;croissante">
        <i class="fas fa-arrow-down-wide-short" aria-hidden="true"></i>
      </button>
    </div>
    <div id="my-ratings" class="search-results">
      {% if rated_items and rated_items|length > 0 %}
        {% for it in rated_items %}
          <div class="result-item" data-rating="{{ it.rating }}">
            <h3 class="result-title">{{ it.name }}</h3>
            <p class="result-score">Ma note: {{ it.rating }}/5</p>
            <div class="stars-slot"></div>
            <!-- description and image will be injected via JS enhanceResultsWithMeta -->
          </div>
        {% endfor %}
      {% else %}
        <p class="text-center text-muted">Vous n'avez pas encore noté de séries.</p>
      {% endif %}
    </div>
  </div>
  <div id="recommendations-loading" class="spinner hidden"></div>
  <div id="recommendations" class="hidden"></div>
  <!-- placeholders not used here, kept to avoid JS errors if referenced -->
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async function(){
  const ratingsContainer = document.getElementById('my-ratings');
  const sortToggle = document.getElementById('ratings-sort-toggle');
  let currentOrder = 'desc';

  function applyRatingsSort(order) {
    if (!ratingsContainer) return;
    const items = Array.from(ratingsContainer.querySelectorAll('.result-item'));
    if (items.length === 0) return;
    items.sort((a, b) => {
      const ra = parseFloat(a.dataset.rating || '0');
      const rb = parseFloat(b.dataset.rating || '0');
      return order === 'asc' ? ra - rb : rb - ra;
    });
    items.forEach(item => ratingsContainer.appendChild(item));
    currentOrder = order;
    updateToggleAppearance();
  }

  function updateToggleAppearance() {
    if (!sortToggle) return;
    const icon = sortToggle.querySelector('i');
    const nextOrder = currentOrder === 'asc' ? 'desc' : 'asc';
    if (icon) {
      icon.className = currentOrder === 'asc' ? 'fas fa-arrow-up-wide-short' : 'fas fa-arrow-down-wide-short';
    }
    const label = nextOrder === 'asc' ? 'Trier par note croissante' : 'Trier par note d&#233;croissante';
    sortToggle.setAttribute('aria-label', label);
    sortToggle.setAttribute('title', label);
  }

  if (sortToggle) {
    sortToggle.addEventListener('click', function(){
      const nextOrder = currentOrder === 'asc' ? 'desc' : 'asc';
      applyRatingsSort(nextOrder);
    });
    applyRatingsSort(currentOrder);
  } else {
    applyRatingsSort(currentOrder);
  }

  try {
    // Ensure we have current ratings in global cache
    if (typeof fetchMyRatings === 'function') { await fetchMyRatings(); }
  } catch(e) {}

  // Render stars widgets using global function
  if (typeof renderStarWidget === 'function') {
    document.querySelectorAll('#my-ratings .result-item').forEach(function(item){
      const titleEl = item.querySelector('.result-title');
      const name = titleEl ? titleEl.textContent.trim() : '';
      const slot = item.querySelector('.stars-slot') || item;
      const init = (window.MY_RATINGS && name && window.MY_RATINGS[name]) ? window.MY_RATINGS[name] : 0;
      renderStarWidget(slot, name, init);
    });
  }

  // Enrich with posters + synopsis
  if (typeof enhanceResultsWithMeta === 'function') {
    enhanceResultsWithMeta('my-ratings');
  }
});
</script>
{% endblock %}

